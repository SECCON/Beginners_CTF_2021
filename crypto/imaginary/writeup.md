
# Writeup - Imaginary

## 問題の概要
虚数を保存できるサービス。
保存した虚数は暗号化した状態でエクスポートしたり、それをインポートしたりできる。

ソースコードを読むと隠しコマンドが用意されていて、 `1337i` を作るとフラグを入手できることがわかる。
しかし、通常の操作では `0 + 1337i` のような値しか作ることができない。

## 解法
データのエクスポート時にECBモードの暗号が使われていることを利用して、ブロックをつなぎ合わせることで `1337i` を作り出す。
そのためには `..., "` で終わるブロックと `1337i": ...` で始まるブロックを用意すればいい。


### (1) 1337i から始まる暗号文の収集
まずは `1337i": ...` で始まるブロックを用意する。
適当に数字の桁数を稼いで2ブロック目の先頭に `1337i` が来るようにすればいい。
具体的には `23456789123 + 1337i` とするとうまくいく。

```
1               2               3               4
0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
{"23456789123 + 1337i": [23456789123, 1337]}
```
このときの暗号文はこうなる。
この2ブロック目以降が `1337i": ...` で始まる暗号文になる。
```
0 1 2 3 4 5 6 7 8 9 a b c d e f 
4690bcdd9077065bf5f52712003dd510
60d56314d465f7bf6dd0279e1b95f951
f46e71373d85fcc3bf4c2b07aa496b19
```

### (2) ..., " で終わる暗号文の収集
続いて、 `..., "` で終わる暗号文ブロックを用意する。
先ほどのデータに適当な値を付け足したとき、何文字付け足せば末尾にこの形が作れるかを考える。
```
1               2               3               4
0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
{"23456789123 + 1337i": [23456789123, 1337]}
{"23456789123 + 1337i": [23456789123, 1337], "0 + 0i": [0, 0], "
```
実部と虚部が共に1桁になれば末尾に `, "` が来るようになる。

以上の考察から、
* 23456789123 + 1337
* 0 + 0i
* 1 + 1i
の3つを順に保存し、エクスポートする。

このとき暗号化されるJSON文字列はこのようになる。
```
1               2               3               4               5
0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
{"23456789123 + 1337i": [23456789123, 1337], "0 + 0i": [0, 0], "1 + 1i": [1, 1]}
```
1~4ブロック目までを使うと末尾に `..., "` という形の暗号文を作れることがわかった。
このときの暗号文は次の通り。
```
0 1 2 3 4 5 6 7 8 9 a b c d e f 
4690bcdd9077065bf5f52712003dd510
60d56314d465f7bf6dd0279e1b95f951
1416d2af204cbdd814a9fc126b488974
2e348d960da74ebe98c2f8096ad24380
450ebe4d6d0ea85378c0212781ca5cdd
8db4341b6d2b363abdc9d13de3042f42
```

### (3) ブロックを組み合わせる
これで作りたい暗号文の元となるブロックはすべて手に入ったことになる。

(2)で入手した暗号文の1~4ブロック目と(1)で入手した暗号文の2ブロック目以降をつなぎ合わせると次のような暗号文を作れる。
```
1               2               3               4               5               6
0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
{"23456789123 + 1337i": [23456789123, 1337], "0 + 0i": [0, 0], "1337i": [23456789123, 1337]}
```

あとは暗号文を取ってきて繋げるだけ。
```
4690bcdd9077065bf5f52712003dd510
60d56314d465f7bf6dd0279e1b95f951
1416d2af204cbdd814a9fc126b488974
2e348d960da74ebe98c2f8096ad24380
60d56314d465f7bf6dd0279e1b95f951
f46e71373d85fcc3bf4c2b07aa496b19
```

```
4690bcdd9077065bf5f52712003dd51060d56314d465f7bf6dd0279e1b95f9511416d2af204cbdd814a9fc126b4889742e348d960da74ebe98c2f8096ad2438060d56314d465f7bf6dd0279e1b95f951f46e71373d85fcc3bf4c2b07aa496b19
```

```
Welcome to Secret IMAGINARY NUMBER Store!
1. Save a number
2. Show numbers
3. Import numbers
4. Export numbers
0. Exit
> 3
Exported String> 4690bcdd9077065bf5f52712003dd51060d56314d465f7bf6dd0279e1b95f9511416d2af204cbdd814a9fc126b4889742e348d960da74ebe98c2f8096ad2438060d56314d465f7bf6dd0279e1b95f951f46e71373d85fcc3bf4c2b07aa496b19
Imported.
--------------------------------------------------
23456789123 + 1337i: (23456789123, 1337)
0 + 0i: (0, 0)
1337i: (23456789123, 1337)
--------------------------------------------------
1. Save a number
2. Show numbers
3. Import numbers
4. Export numbers
0. Exit
> 5
Congratulations!
The flag is ctf4b{yeah_you_are_a_member_of_imaginary_number_club}
```
